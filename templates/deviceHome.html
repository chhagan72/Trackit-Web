<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>TrackIt - Device Details</title>

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Bootstrap Favicon -->
  <link rel="icon" href="https://getbootstrap.com/docs/5.3/assets/img/favicons/favicon.ico" type="image/x-icon" />

  <!-- <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script> -->

  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css" />
  <link rel="stylesheet" href="/static/css/homeDeviceStyle.css">


  <script src="https://unpkg.com/leaflet/dist/leaflet.js" defer></script>
  <script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.js"></script>


</head>

<body>
  <nav class="navbar navbar-expand-lg navbar-white bg-white">
    <div class="container-fluid">
      <a class="navbar-brand" href="#">
        <h4 class="mb-0">TrackIt <span class="text-muted">My Device</span></h4>
      </a>
      <div class="collapse navbar-collapse justify-content-end" id="navbarNav">
        <ul class="navbar-nav">
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" id="profileDropdown" role="button" data-bs-toggle="dropdown">
              User Profile
            </a>
            <ul class="dropdown-menu dropdown-menu-end">
              <li><a class="dropdown-item" href="{% url 'device_profile' device_id=device.device_id %}">Profile</a></li>
              <li>
                <hr class="dropdown-divider" />
              </li>
              <li><a class="dropdown-item text-danger" href="{% url 'logout' %}">Logout</a></li>
            </ul>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <div class="content">
    <div class="sidebar">
      <div class="device-card mb-3 border rounded p-2">
        <button class="btn btn-sm btn-light refresh-btn" onclick="refreshDeviceDetails()" title="Refresh">ðŸ”„</button>
        <div class="row">
          <div class="col-4">
            <img src="/static/assets/phone.png" alt="Phone" class="img-fluid" />
          </div>
          <div class="col-8 phoneDetails" id="deviceDetails">
            <h6>Device Name: <span id="deviceName">{{ device.deviceName }}</span></h6>
            <p>IMEI: <span id="imei">{{ device.imei|default:"Unknown" }}</span></p>
            <p>Battery: <span id="batteryStatus">{{ device.batteryStatus|default:"N/A" }}</span></p>
            <p>Status: <span id="status">{{ device.status|default:"Unknown" }}</span></p>
          </div>
        </div>
      </div>

      <button id="ringButton" class="btn btn-action btn-primary" onclick="toggleRing()">Play Sound</button>
      <button class="btn btn-action btn-primary" onclick="sendCommand('lock')">Lock Device</button>
      <button class="btn btn-action btn-primary" onclick="confirmReset()">Factory Reset</button>
      <button class="btn btn-action btn-primary" onclick="getLiveLocation()">Live Location</button>
      <button class="btn btn-action btn-primary" onclick="getLastLocation()">Last Location</button>
      <button class="btn btn-action btn-primary" onclick="getDirection()">Get Direction</button>
      <button class="btn btn-action btn-primary" data-bs-toggle="modal"
        data-bs-target="#messageModal">Messaging</button>

    </div>

    <div class="map-container">
      <div id="map"></div>
      <div id="distanceInfo" style="display: none;"></div>
      <!-- <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBUUu1xc5Q3BtYTc63XEyYR8wNTpPtpb80&callback=initMap"
        async defer></script> -->
      <script
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBUUu1xc5Q3BtYTc63XEyYR8wNTpPtpb80&libraries=geometry&callback=initMap"
        async defer></script>
      <!-- <script src="/static/js/map.js"></script> -->

    </div>
    <!-- Message Modal -->
    <div class="modal fade" id="messageModal" tabindex="-1" aria-labelledby="messageModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="messageModalLabel">Send Message to Device</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <textarea id="messageInput" class="form-control" placeholder="Enter your message..." rows="4"></textarea>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="button" class="btn btn-primary" onclick="sendMessageToDevice()">Send</button>
          </div>
        </div>
      </div>
    </div>

  </div>



  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
  <script>
    // const deviceId = "{{ device_id|escapejs }}";
    // const userId = "{{ request.session.user_id|escapejs }}";

    const firebaseConfig = {
      apiKey: "AIzaSyDpbVFgPlPgcGXQttylQK_HQfhD6b0VElc",
      authDomain: "trackits-ea795.firebaseapp.com",
      databaseURL: "https://trackits-ea795-default-rtdb.firebaseio.com",
      projectId: "trackits-ea795",
      storageBucket: "trackits-ea795.appspot.com",
      messagingSenderId: "19130318782",
      appId: "1:19130318782:web:b21be85d894b8ba428c3ef",
    };

    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    const deviceId = "{{ device_id }}";
    const userId = "{{ request.session.user_id }}";

    const dbRef = database.ref(`users/${userId}/devices/${deviceId}`);
    let ringStatus = false;

    function toggleRing() {
      ringStatus = !ringStatus;
      updateCommand("ring", ringStatus);
      document.getElementById("ringButton").textContent = ringStatus ? "Stop Sound" : "Play Sound";
    }

    function sendCommand(command) {
      updateCommand(command, true);
    }

    function updateCommand(command, value) {
      const commandPath = `users/${userId}/devices/${deviceId}/commands/${command}`;
      database
        .ref(commandPath)
        .set(value)
        .then(() => alert(`${command} command ${value ? "sent" : "stopped"} successfully`))
        .catch((error) => alert(`Failed to send command: ${error.message}`));
    }

    function confirmReset() {
      if (confirm("Are you sure you want to factory reset this device?")) {
        updateCommand("erase", true);
      }
    }


    function sendMessageToDevice() {
      const messageText = document.getElementById("messageInput").value.trim();
      if (!messageText) return alert("Please enter a message");

      // Send message and trigger the command
      database.ref(`users/${userId}/devices/${deviceId}/commands`).update({
        show_message: true
      });

      database.ref(`users/${userId}/devices/${deviceId}/commands`).update({
        message: messageText
      });

      // Optional: Close modal and clear input
      document.getElementById("messageInput").value = "";
      const modal = bootstrap.Modal.getInstance(document.getElementById("messageModal"));
      modal.hide();
    }

    function refreshDeviceDetails() {
      dbRef.once("value")
        .then((snapshot) => {
          const data = snapshot.val();
          if (data) {
            document.getElementById("deviceName").textContent = data.deviceName || "N/A";
            document.getElementById("imei").textContent = data.imei || "Unknown";
            document.getElementById("batteryStatus").textContent = data.batteryStatus || "N/A";
            document.getElementById("status").textContent = data.status || "Unknown";
          } else {
            alert("Device data not found.");
          }
        })
        .catch((error) => alert("Error fetching device details: " + error.message));
    }

    let map, deviceMarker, userMarker, directionRenderer, directionService;

    let userLocation = null;
    let watchId = null;

    let isMapInitialized = false;

    // function initMap(lat = 0, lng = 0) {
    //   if (isMapInitialized) return;

    //   map = L.map('map').setView([lat, lng], 16);
    //   isMapInitialized = true;

    //   L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    //     attribution: 'Map data Â© OpenStreetMap contributors',
    //   }).addTo(map);

    //   // deviceMarker = L.marker([18.5204, 73.8567]).addTo(map)
    //   //   .bindPopup("ðŸ“ Waiting for your location...").openPopup();


    //   deviceMarker = L.marker([lat, lng], { title: "Device Location" }).addTo(map);
    //   userMarker = L.marker([lat, lng], { title: "Your Location", opacity: 0.8 }).addTo(map);
    // }

    function initMap(lat = 0, lng = 0) {
      if (isMapInitialized) return;

      map = L.map('map').setView([lat, lng], 16);
      isMapInitialized = true;

      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Map data Â© OpenStreetMap contributors',
      }).addTo(map);

      deviceMarker = L.marker([lat, lng]).addTo(map).bindPopup("Device Location").openPopup();

      // Optionally: fetch location from Firebase if available
      dbRef.child('location').once('value').then(snapshot => {
        const location = snapshot.val();
        if (location && location.latitude && location.longitude) {
          updateDeviceMarker(location.latitude, location.longitude);
        }
      });
    }

    function updateDeviceMarker(lat, lng) {
      if (deviceMarker) {
        deviceMarker.setLatLng([lat, lng]);
      } else {
        deviceMarker = L.marker([lat, lng]).addTo(map).bindPopup("Device Location");
      }
      map.setView([lat, lng], 16);
    }

    function getLiveLocation() {
      database.ref(`users/${userId}/devices/${deviceId}/location`).on("value", (snapshot) => {
        const location = snapshot.val();
        if (location && location.latitude && location.longitude) {
          const latLng = [location.latitude, location.longitude];

          if (!map) {
            initMap(location.latitude, location.longitude);
          }

          if (deviceMarker) {
            deviceMarker.setLatLng(latLng);
          } else {
            deviceMarker = L.marker(latLng).addTo(map).bindPopup("Live Device Location").openPopup();
          }

          map.setView(latLng, 16);
        }
      });
    }

    // Get Last Location (one-time fetch)
    function getLastLocation() {
      dbRef.child("location").once("value", (snapshot) => {
        const data = snapshot.val();
        if (data && data.latitude && data.longitude) {
          const lat = data.latitude;
          const lng = data.longitude;

          if (!deviceMarker) {
            deviceMarker = L.marker([lat, lng]).addTo(map).bindPopup("Last Known Location");
          } else {
            deviceMarker.setLatLng([lat, lng]);
          }

          map.setView([lat, lng], 16);
        } else {
          alert("Last location not available.");
        }
      });
    }


    // Get Direction from user to device
    function getDirection() {
      if (!navigator.geolocation) {
        alert("Geolocation is not supported by your browser");
        return;
      }

      navigator.geolocation.getCurrentPosition(
        (position) => {
          const userLat = position.coords.latitude;
          const userLng = position.coords.longitude;
          userLocation = [userLat, userLng];

          dbRef.child("location").once("value", (snapshot) => {
            const data = snapshot.val();
            if (data && data.latitude && data.longitude) {
              const deviceLat = data.latitude;
              const deviceLng = data.longitude;

              if (userMarker) {
                userMarker.setLatLng(userLocation);
              } else {
                userMarker = L.marker(userLocation, { color: "blue" }).addTo(map).bindPopup("Your Location");
              }

              if (deviceMarker) {
                deviceMarker.setLatLng([deviceLat, deviceLng]);
              } else {
                deviceMarker = L.marker([deviceLat, deviceLng]).addTo(map).bindPopup("Device Location");
              }

              map.setView([deviceLat, deviceLng], 13);

              L.Routing.control({
                waypoints: [
                  L.latLng(userLat, userLng),
                  L.latLng(deviceLat, deviceLng)
                ],
                routeWhileDragging: false
              }).addTo(map);
              drawRoute();

              // Calculate distance using Leaflet geometry
              const distanceInMeters = map.distance([userLat, userLng], [deviceLat, deviceLng]);
              const distanceText =
                distanceInMeters >= 1000
                  ? (distanceInMeters / 1000).toFixed(2) + " km"
                  : Math.round(distanceInMeters) + " meters";

              const distanceDiv = document.getElementById("distanceInfo");
              distanceDiv.innerHTML = `<div class="alert alert-info m-2">Distance to device: <strong>${distanceText}</strong></div>`;
              distanceDiv.style.display = "block";
            } else {
              alert("Device location not available.");
            }
          });
        },
        (error) => {
          alert("Error getting user location: " + error.message);
        }
      );
    }

    let routeControl;

    function drawRoute() {
      if (routeControl) {
        map.removeControl(routeControl);
      }

      routeControl = L.Routing.control({
        waypoints: [
          L.latLng(userLocation.lat, userLocation.lng),
          L.latLng(deviceLocation.lat, deviceLocation.lng)
        ],
        routeWhileDragging: false,
        createMarker: function (i, waypoint, n) {
          if (i === 0) {
            return L.marker(waypoint.latLng, { title: "Your Location" });
          } else {
            return L.marker(waypoint.latLng, { title: "Device Location" });
          }
        }
      }).addTo(map);
    } 
    // setInterval(() => {
    //   getDirection(); 
    // }, 10000);

    window.onload = function () {
      refreshDeviceDetails();
    };
  </script>
  <!-- <script src="/static/js/homeDeviceScript1.js"></script> -->

</body>

</html>